<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Últimos Movimientos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .highlight-new { background: rgba(25, 135, 84, 0.12); transition: background 1.2s, transform .3s; border-left:4px solid rgba(25,135,84,.25); }
    .saldo-anim { font-size:1.4rem; transition: color .4s, transform .35s; }
    #lista li { cursor: default; }
    .suggestion { cursor: pointer; }
    /* Nuevos estilos */
    #lista li:hover { transform: translateY(-3px); box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .tx-positive { color: #0f5132; }
    .tx-negative { color: #842029; }
    .fade-in { animation: fadeInUp .26s ease both; }
    @keyframes fadeInUp { from { opacity:0; transform: translateY(6px);} to { opacity:1; transform: translateY(0);} }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="text-center mb-3">Últimos Movimientos</h2>

    <div class="card p-3 shadow">
      <div class="row g-2 align-items-center mb-3">
        <div class="col-12 col-md-6">
          <select id="filtro" class="form-select">
            <option value="todos">Todos</option>
            <option value="depósito">Depósitos</option>
            <option value="transferencia enviada">Transferencias Enviadas</option>
            <option value="compra">Compras</option>
          </select>
        </div>
        <div class="col-12 col-md-6 text-end">
          <button id="btnRefresh" class="btn btn-sm btn-outline-secondary">Refrescar</button>
        </div>
      </div>

      <div class="mb-2 d-flex justify-content-between align-items-center">
        <div>
          <small class="text-muted">Saldo disponible</small>
          <div id="saldo" class="fw-bold saldo-anim">€ 0.00</div>
        </div>
        <div>
          <button id="btnClear" class="btn btn-outline-danger btn-sm">Borrar movimientos (dev)</button>
        </div>
      </div>

      <ul id="lista" class="list-group" style="max-height:360px; overflow:auto;"></ul>

      <div class="mt-3 d-flex justify-content-between">
        <button onclick="goTo('menu.html')" class="btn btn-primary">Volver al Menú</button>
        <button id="btnClear2" class="btn btn-outline-danger d-none">Borrar movimientos (dev)</button>
      </div>
    </div>
  </div>

  <script src="JS/app.js"></script>

  <script>
    $(function(){
      // Caché de selectores
      const $lista = $("#lista");
      const $filtro = $("#filtro");
      const $saldo = $("#saldo");
      const $btnRefresh = $("#btnRefresh");
      const STORAGE_KEY = "transacciones";

      // Util: formatear dinero
      function formatearDinero(n) {
        const sign = n < 0 ? "-" : "";
        return sign + "€ " + Math.abs(n).toFixed(2);
      }

      // Leer transacciones desde localStorage
      function leerTransacciones() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
        catch (e) { return []; }
      }

      // Calcular saldo
      function calcularSaldo() {
        return leerTransacciones().reduce((s, t) => s + Number(t.monto || 0), 0);
      }

      // Animar saldo (tween)
      function animarSaldo(target) {
        const currentText = $saldo.text().replace(/[^\d\-,.]/g, "").replace(",", ".");
        const current = parseFloat(currentText) || 0;
        const steps = 20;
        const diff = target - current;
        let i = 0;
        const duration = 350;
        const timer = setInterval(() => {
          i++;
          const prog = i / steps;
          const eased = prog * (2 - prog); // simple easing
          const value = current + diff * eased;
          $saldo.text(formatearDinero(value));
          if (i >= steps) {
            clearInterval(timer);
            $saldo.text(formatearDinero(target));
            $saldo.addClass("text-success").css("transform","scale(1.03)");
            setTimeout(()=> $saldo.removeClass("text-success").css("transform",""), 650);
          }
        }, duration/steps);
      }

      // Renderizar lista con efectos
      function render(filtro) {
        $lista.stop(true,true);
        $lista.empty();
        const all = leerTransacciones();
        // Soporta función externa de filtrado si existe
        const items = (typeof filtrarTransacciones === "function")
          ? filtrarTransacciones(filtro || "todos")
          : (filtro === "todos" ? all : all.filter(t => t.tipo === filtro));

        if (!items || items.length === 0) {
          $lista.append(`<li class="list-group-item text-muted">No hay movimientos para mostrar.</li>`);
          animarSaldo(calcularSaldo());
          return;
        }

        // Mostrar de más reciente a más antiguo
        const rev = items.slice().reverse();
        rev.forEach((t, idx) => {
          const monto = Number(t.monto || 0);
          const cls = monto >= 0 ? "tx-positive" : "tx-negative";
          const $li = $(`
            <li class="list-group-item fade-in">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>${t.tipo}</strong><br>
                  <small class="text-muted">${t.fecha || ''}</small>
                  ${t.descripcion ? `<div class="small text-muted">${t.descripcion}</div>` : ''}
                </div>
                <div class="text-end">
                  <div class="${cls}"><strong>${formatearDinero(monto)}</strong></div>
                </div>
              </div>
            </li>
          `).hide();

          $lista.append($li);
          $li.delay(idx * 30).fadeIn(200);
        });

        // Highlight al más reciente
        const $first = $lista.children("li").first();
        $first.addClass("highlight-new");
        setTimeout(()=> $first.removeClass("highlight-new"), 1200);

        // Animar saldo calculado
        animarSaldo(calcularSaldo());
      }

      // Manejo de eventos optimizado (delegado cuando aplica)
      $filtro.on("change", ()=> render($filtro.val()));
      $btnRefresh.on("click", ()=> render($filtro.val()));

      // Botón borrar (dev)
      $(document).on("click", "#btnClear", function(){
        if (!confirm("Borrar todas las transacciones? Esto es útil solo en desarrollo.")) return;
        localStorage.setItem(STORAGE_KEY, JSON.stringify([]));
        localStorage.setItem("lastUpdate", Date.now());
        // trigger storage para otras pestañas
        render($filtro.val());
      });

      // Inicial
      render("todos");

      // Actualizar al volver al foco
      $(window).on("focus", ()=> render($filtro.val()));

      // Escuchar storage events para actualizaciones desde otras pestañas/ventanas
      window.addEventListener("storage", (e) => {
        if (!e.key) return;
        if (e.key === STORAGE_KEY || e.key === "lastUpdate") {
          render($filtro.val());
        }
      });

      // Escuchar evento personalizado local para adiciones rápidas desde sendmoney.html
      $(window).on("tx:added", (ev, nuevo) => {
        // inserta en UI sin recargar todo para suavidad
        const monto = Number(nuevo.monto || 0);
        const cls = monto >= 0 ? "tx-positive" : "tx-negative";
        const $li = $(`
          <li class="list-group-item fade-in highlight-new">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <strong>${nuevo.tipo}</strong><br>
                <small class="text-muted">${nuevo.fecha || ''}</small>
              </div>
              <div class="text-end"><div class="${cls}"><strong>${formatearDinero(monto)}</strong></div></div>
            </div>
          </li>
        `).hide();
        $lista.prepend($li);
        $li.fadeIn(260);
        setTimeout(()=> $li.removeClass("highlight-new"), 1200);
        // animar saldo a nuevo valor
        animarSaldo(calcularSaldo());
      });
    });
  </script>
</body>
</html>
