// ...existing code...
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Últimos Movimientos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .highlight-new { background: rgba(25, 135, 84, 0.08); transition: background 1.2s; }
    .saldo-anim { font-size:1.4rem; transition: color .4s; }
    #lista li { cursor: default; }
    .suggestion { cursor: pointer; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="text-center mb-3">Últimos Movimientos</h2>

    <div class="card p-3 shadow">
      <div class="row g-2 align-items-center mb-3">
        <div class="col-12 col-md-6">
          <select id="filtro" class="form-select">
            <option value="todos">Todos</option>
            <option value="depósito">Depósitos</option>
            <option value="transferencia enviada">Transferencias Enviadas</option>
            <option value="compra">Compras</option>
          </select>
        </div>
        <div class="col-12 col-md-6 text-end">
          <button id="btnRefresh" class="btn btn-sm btn-outline-secondary">Refrescar</button>
        </div>
      </div>

      <div class="mb-2 d-flex justify-content-between align-items-center">
        <div>
          <small class="text-muted">Saldo disponible</small>
          <div id="saldo" class="fw-bold saldo-anim">€ 0.00</div>
        </div>
        <div>
          <button id="btnClear" class="btn btn-outline-danger btn-sm">Borrar movimientos (dev)</button>
        </div>
      </div>

      <ul id="lista" class="list-group" style="max-height:360px; overflow:auto;"></ul>

      <div class="mt-3 d-flex justify-content-between">
        <button onclick="goTo('menu.html')" class="btn btn-primary">Volver al Menú</button>
        <button id="btnClear2" class="btn btn-outline-danger d-none">Borrar movimientos (dev)</button>
      </div>
    </div>
  </div>

  <script src="JS/app.js"></script>

  <script>
    $(function(){
      // Caché de selectores
      const $lista = $("#lista");
      const $filtro = $("#filtro");
      const $saldo = $("#saldo");
      const $btnRefresh = $("#btnRefresh");

      // Utility: formatear dinero
      function formatearDinero(n) {
        const sign = n < 0 ? "-" : "";
        return sign + "€ " + Math.abs(n).toFixed(2);
      }

      // Leer transacciones desde localStorage
      function leerTransacciones() {
        try {
          return JSON.parse(localStorage.getItem("transacciones") || "[]");
        } catch (e) { return []; }
      }

      // Calcular saldo sumando montos (asume depositos positivos, envios negativos)
      function calcularSaldo() {
        const tx = leerTransacciones();
        return tx.reduce((s, t) => s + Number(t.monto || 0), 0);
      }

      // Animar número del saldo
      function animarSaldo(target) {
        const currentText = $saldo.text().replace(/[^\d\-,.]/g, "").replace(",", ".");
        const current = parseFloat(currentText) || 0;
        const steps = 20;
        const diff = target - current;
        let i = 0;
        const start = Date.now();
        const duration = 350;
        const timer = setInterval(() => {
          i++;
          const prog = i / steps;
          const value = current + diff * prog;
          $saldo.text(formatearDinero(value));
          if (i >= steps) {
            clearInterval(timer);
            $saldo.text(formatearDinero(target));
            $saldo.addClass("text-success");
            setTimeout(()=> $saldo.removeClass("text-success"), 700);
          }
        }, duration/steps);
      }

      // Render con efectos
      function render(filtro) {
        $lista.stop(true,true);
        $lista.empty();
        const all = leerTransacciones();
        const items = (typeof filtrarTransacciones === "function")
          ? filtrarTransacciones(filtro || "todos")
          : (filtro === "todos" ? all : all.filter(t => t.tipo === filtro));
        if (!items || items.length === 0) {
          $lista.append(`<li class="list-group-item text-muted">No hay movimientos para mostrar.</li>`);
          animarSaldo(calcularSaldo());
          return;
        }

        // Mostrar de más reciente a más antiguo (reverse)
        const rev = items.slice().reverse();
        rev.forEach((t, idx) => {
          const $li = $(`
            <li class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>${t.tipo}</strong><br>
                  <small class="text-muted">${t.fecha || ''}</small>
                </div>
                <div class="text-end"><strong>${formatearDinero(Number(t.monto || 0))}</strong></div>
              </div>
            </li>
          `).hide();

          // Animacion escalonada
          $lista.append($li);
          $li.delay(idx * 40).fadeIn(220);
        });

        // Marcar el primero (más reciente) con un highlight momentáneo
        const $first = $lista.children("li").first();
        $first.addClass("highlight-new");
        setTimeout(()=> $first.removeClass("highlight-new"), 1200);

        // Animar saldo calculado
        animarSaldo(calcularSaldo());
      }

      // Eventos
      $filtro.on("change", ()=> render($filtro.val()));
      $btnRefresh.on("click", ()=> render($filtro.val()));

      $("#btnClear").on("click", function(){
        if (!confirm("Borrar todas las transacciones? Esto es útil solo en desarrollo.")) return;
        localStorage.setItem("transacciones", JSON.stringify([]));
        // también forzar notificación para otras pestañas
        localStorage.setItem("lastUpdate", Date.now());
        render($filtro.val());
      });

      // Inicial
      render("todos");

      // Si regresas desde otra pestaña/pantalla actualiza
      $(window).on("focus", ()=> render($filtro.val()));

      // Escuchar storage events para actualizaciones desde otras pestañas/ventanas (o sendmoney)
      window.addEventListener("storage", (e) => {
        if (!e.key) return;
        if (e.key === "transacciones" || e.key === "lastUpdate") {
          render($filtro.val());
        }
      });
    });
  </script>
</body>
</html>
// ...existing code...